<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ESP32 Simulator — SUNSTONE</title>
<style>
  :root{--pri:#3b4998}
  *{box-sizing:border-box}
  body{font-family:Segoe UI,system-ui,-apple-system,Arial;background:#f5f6fa;color:#222;margin:0;padding:24px}
  .wrap{max-width:900px;margin:auto}
  .card{background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:18px;margin-bottom:18px}
  h1{margin:0 0 6px;color:var(--pri)}
  h2{margin:0 0 12px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1}
  label{display:block;font-weight:600;margin-bottom:6px}
  input[type="text"],input[type="number"]{width:100%;padding:10px;border:2px solid #e3e6ef;border-radius:8px}
  .btn{border:0;border-radius:8px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn-pri{background:var(--pri);color:#fff}
  .btn-sec{background:#eef1fb;color:#223}
  .btn-dan{background:#dc3545;color:#fff}
  .grid{display:grid;grid-template-columns:repeat(4,minmax(120px,1fr));gap:12px}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
  .ok{background:#d4edda;color:#155724}
  .warn{background:#fff3cd;color:#856404}
  .err{background:#f8d7da;color:#721c24}
  .muted{color:#666;font-size:13px}
  .log{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0b1220;color:#cfe3ff;border-radius:10px;padding:10px;max-height:240px;overflow:auto}
  .log b{color:#8dd2ff}
  .inline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .spacer{height:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ESP32 Simulator</h1>
    <div class="muted">Mengirim data sensor ke backend kamu melalui <b>POST /session/{id}/sensor</b>.</div>
  </div>

  <!-- KONFIGURASI -->
  <div class="card">
    <h2>Konfigurasi</h2>
    <div class="row">
      <div class="col">
        <label>API URL</label>
        <input id="apiUrl" type="text" placeholder="https://...execute-api....amazonaws.com/{stage}">
      </div>
      <div class="col">
        <label>API Key</label>
        <input id="apiKey" type="text" placeholder="xxxxxxxx">
      </div>
      <div class="col" style="max-width:220px">
        <label>Device ID</label>
        <input id="deviceId" type="text" placeholder="ESP01">
      </div>
    </div>
    <div class="spacer"></div>
    <div class="inline">
      <button class="btn btn-sec" id="saveCfgBtn">Simpan</button>
      <span id="cfgStatus" class="pill warn">Belum tersambung</span>
      <span class="muted">Tip: isi & simpan, lalu klik “Cari Sesi OPEN”.</span>
    </div>
  </div>

  <!-- STATUS SESI -->
  <div class="card">
    <h2>Status Sesi</h2>
    <div class="inline">
      <button class="btn btn-pri" id="findOpenBtn">Cari Sesi OPEN</button>
      <div id="sessionPill" class="pill warn">Tidak ada sesi</div>
    </div>
    <div class="muted" id="sessionInfo">Belum memeriksa.</div>
  </div>

  <!-- NILAI SENSOR -->
  <div class="card">
    <h2>Input Sensor</h2>
    <div class="grid">
      <div>
        <label>S1</label>
        <input id="s1" type="number" value="10" step="1">
      </div>
      <div>
        <label>S2</label>
        <input id="s2" type="number" value="20" step="1">
      </div>
      <div>
        <label>S3</label>
        <input id="s3" type="number" value="30" step="1">
      </div>
      <div>
        <label>S4</label>
        <input id="s4" type="number" value="40" step="1">
      </div>
    </div>
    <div class="spacer"></div>
    <div class="row">
      <div class="col">
        <label>Mode</label>
        <div class="inline">
          <button class="btn btn-sec" id="randOffBtn">Manual</button>
          <button class="btn btn-sec" id="randOnBtn">Acak ±5</button>
          <span id="randPill" class="pill warn">Manual</span>
        </div>
      </div>
      <div class="col" style="max-width:220px">
        <label>Interval (ms)</label>
        <input id="interval" type="number" value="1000" min="200" step="100">
      </div>
    </div>
  </div>

  <!-- KONTROL -->
  <div class="card">
    <h2>Kirim</h2>
    <div class="inline">
      <button class="btn btn-pri" id="sendOnceBtn">Kirim Sekali</button>
      <button class="btn btn-pri" id="autoBtn">Mulai Auto</button>
      <button class="btn btn-dan" id="stopBtn" disabled>Stop</button>
      <span id="sendPill" class="pill warn">Idle</span>
    </div>
    <div class="spacer"></div>
    <div class="muted">Simulator <b>tidak akan membuka sesi baru</b>. Jika tidak ada sesi OPEN, buka dari web user dulu.</div>
  </div>

  <!-- LOG -->
  <div class="card">
    <h2>Log</h2>
    <div id="log" class="log"></div>
  </div>
</div>

<script>
/* ====== CONFIG (ISI PUNYAMU) ========================================== */
const API = {
  url: "https://8308ialq3d.execute-api.ap-southeast-1.amazonaws.com/tros-20251007091134-4239", // <- ganti bila perlu
  key: "75179e4b24c0179f1806d2a18707e7cb",                                                   // <- ganti bila perlu
  deviceId: "ESP01"                                                                           // <- ganti bila perlu
};
/* ===================================================================== */

const els = {
  apiUrl: document.getElementById('apiUrl'),
  apiKey: document.getElementById('apiKey'),
  deviceId: document.getElementById('deviceId'),
  saveCfgBtn: document.getElementById('saveCfgBtn'),
  cfgStatus: document.getElementById('cfgStatus'),
  findOpenBtn: document.getElementById('findOpenBtn'),
  sessionPill: document.getElementById('sessionPill'),
  sessionInfo: document.getElementById('sessionInfo'),
  s: [document.getElementById('s1'),document.getElementById('s2'),document.getElementById('s3'),document.getElementById('s4')],
  randOffBtn: document.getElementById('randOffBtn'),
  randOnBtn: document.getElementById('randOnBtn'),
  randPill: document.getElementById('randPill'),
  interval: document.getElementById('interval'),
  sendOnceBtn: document.getElementById('sendOnceBtn'),
  autoBtn: document.getElementById('autoBtn'),
  stopBtn: document.getElementById('stopBtn'),
  sendPill: document.getElementById('sendPill'),
  log: document.getElementById('log'),
};

const LS = {
  url: 'sim.apiUrl', key: 'sim.apiKey', dev: 'sim.deviceId', rand:'sim.rand', it:'sim.interval'
};

let state = {
  sessionId: null,
  autoTimer: null,
  randomMode: localStorage.getItem(LS.rand) === '1',
  consecutiveFails: 0
};

function log(msg, kind='info'){
  const ts = new Date().toLocaleTimeString();
  const line = document.createElement('div');
  line.innerHTML = kind==='err' ? `<b>[${ts}]</b> ❌ ${msg}` :
                   kind==='ok'  ? `<b>[${ts}]</b> ✅ ${msg}` :
                                  `<b>[${ts}]</b> ${msg}`;
  els.log.prepend(line);
  while (els.log.childElementCount > 300) els.log.removeChild(els.log.lastChild);
}

function setPill(el, cls, text){
  el.className = `pill ${cls}`;
  el.textContent = text;
}

function headers(){ return {'content-type':'application/json','x-api-key': els.apiKey.value.trim()}; }

async function call(path, method='GET', body=null){
  const res = await fetch(els.apiUrl.value.trim() + path, {
    method, headers: headers(), body: body ? JSON.stringify(body) : undefined,
  });
  if(!res.ok){
    const t = await res.text().catch(()=>`${res.status}`);
    throw new Error(`${method} ${path} -> ${res.status} ${t}`);
  }
  return res.json();
}

async function ping(){
  try{
    const t0 = performance.now();
    const js = await call('/history','GET');
    const ms = Math.round(performance.now()-t0);
    setPill(els.cfgStatus,'ok',`API OK (${ms}ms)`);
    log(`API /history OK (${ms}ms), patients=${(js.patients||[]).length}`,'ok');
    return js;
  }catch(e){
    setPill(els.cfgStatus,'err','API gagal');
    log(`API check gagal: ${e.message}`,'err');
    throw e;
  }
}

async function findOpen(){
  setPill(els.sessionPill,'warn','Mencari…');
  els.sessionInfo.textContent = 'Memeriksa /history...';
  try{
    const js = await ping();
    const open = (js.patients||[]).find(p=>p.status==='OPEN');
    if(!open){
      state.sessionId = null;
      setPill(els.sessionPill,'err','Tidak ada sesi OPEN');
      els.sessionInfo.textContent = 'Buka sesi dari web user dulu.';
      log('Tidak ada sesi OPEN.','err');
      toggleSendUI(false);
      return;
    }
    // opsional: validasi device id konsisten dengan sesi
    if(open.device_id && open.device_id !== els.deviceId.value.trim()){
      log(`Peringatan: device sesi=${open.device_id}, tapi simulator diset ${els.deviceId.value.trim()}`,'err');
    }
    state.sessionId = open.id;
    setPill(els.sessionPill,'ok',`OPEN: ${state.sessionId}`);
    els.sessionInfo.textContent = `sessionStart: ${open.sessionStart || '-'}`;
    log(`OPEN session: ${state.sessionId}`,'ok');
    toggleSendUI(true);
  }catch(e){
    state.sessionId = null;
    setPill(els.sessionPill,'err','Gagal cek sesi');
    els.sessionInfo.textContent = e.message;
    toggleSendUI(false);
  }
}

function toggleSendUI(enabled){
  els.sendOnceBtn.disabled = !enabled;
  els.autoBtn.disabled = !enabled;
  if(!enabled){ stopAuto(); }
}

function randAround(v){ return v + (Math.random()*10-5)|0; }

function readValues(){
  const vals = els.s.map(x=>Number(x.value||0));
  if(state.randomMode){
    for(let i=0;i<vals.length;i++) vals[i] = randAround(vals[i]);
  }
  return vals;
}

async function sendOnce(){
  if(!state.sessionId){ log('Tidak ada sesi OPEN.','err'); return; }
  const values = readValues();
  const ts = new Date().toISOString();
  try{
    const r = await call(`/session/${encodeURIComponent(state.sessionId)}/sensor`, 'POST', { values, timestamp: ts });
    log(`Publish OK → ${JSON.stringify(r.published||{})}`,'ok');
    state.consecutiveFails = 0;
    setPill(els.sendPill,'ok','Last OK');
  }catch(e){
    state.consecutiveFails++;
    log('Gagal publish: ' + e.message, 'err');
    setPill(els.sendPill,'err','Error');
    // auto stop kalau gagal 5x berturut
    if(state.autoTimer && state.consecutiveFails >= 5){
      log('Auto dihentikan (gagal 5x).','err');
      stopAuto();
    }
  }
}

function startAuto(){
  if(!state.sessionId){ log('Tidak ada sesi OPEN.','err'); return; }
  const iv = Math.max(200, Number(els.interval.value||1000));
  if(state.autoTimer) clearInterval(state.autoTimer);
  state.autoTimer = setInterval(sendOnce, iv);
  setPill(els.sendPill,'warn',`Auto ${iv}ms`);
  els.autoBtn.disabled = true;
  els.stopBtn.disabled = false;
  log('Auto start.');
}

function stopAuto(){
  if(state.autoTimer) clearInterval(state.autoTimer);
  state.autoTimer = null;
  els.autoBtn.disabled = false;
  els.stopBtn.disabled = true;
  setPill(els.sendPill,'warn','Idle');
  log('Auto stop.');
}

function setRandomMode(on){
  state.randomMode = !!on;
  localStorage.setItem(LS.rand, on ? '1':'0');
  setPill(els.randPill, on?'ok':'warn', on?'Acak ±5':'Manual');
}

function saveCfg(){
  localStorage.setItem(LS.url, els.apiUrl.value.trim());
  localStorage.setItem(LS.key, els.apiKey.value.trim());
  localStorage.setItem(LS.dev, els.deviceId.value.trim());
  localStorage.setItem(LS.it, els.interval.value.trim());
  log('Konfigurasi disimpan.'); ping().catch(()=>{});
}

function loadCfg(){
  els.apiUrl.value = localStorage.getItem(LS.url) || API.url;
  els.apiKey.value = localStorage.getItem(LS.key) || API.key;
  els.deviceId.value = localStorage.getItem(LS.dev) || API.deviceId;
  els.interval.value = localStorage.getItem(LS.it) || '1000';
  setRandomMode(localStorage.getItem(LS.rand)==='1');
}

function wire(){
  els.saveCfgBtn.onclick = saveCfg;
  els.findOpenBtn.onclick = findOpen;
  els.sendOnceBtn.onclick = sendOnce;
  els.autoBtn.onclick = startAuto;
  els.stopBtn.onclick = stopAuto;
  els.randOffBtn.onclick = ()=>setRandomMode(false);
  els.randOnBtn.onclick = ()=>setRandomMode(true);
}

document.addEventListener('DOMContentLoaded', ()=>{
  loadCfg(); wire(); ping().catch(()=>{});
  // coba cari sesi open otomatis beberapa detik kemudian
  setTimeout(findOpen, 400);
  // pantau perubahan sesi setiap 5 detik (mis. user menutup/membuka dari web)
  setInterval(async ()=>{
    const before = state.sessionId;
    try{
      const js = await call('/history','GET');
      const open = (js.patients||[]).find(p=>p.status==='OPEN');
      const sid = open ? open.id : null;
      if(sid !== before){
        state.sessionId = sid;
        if(sid){
          setPill(els.sessionPill,'ok',`OPEN: ${sid}`);
          els.sessionInfo.textContent = `sessionStart: ${open.sessionStart || '-'}`;
          toggleSendUI(true);
          log(`Sesi berganti → ${sid}`,'ok');
        }else{
          setPill(els.sessionPill,'err','Tidak ada sesi OPEN');
          els.sessionInfo.textContent = 'Buka sesi dari web user dulu.';
          toggleSendUI(false);
          log('Semua sesi CLOSED.','err');
        }
      }
    }catch(e){ /* diamkan */ }
  }, 5000);
});
</script>
</body>
</html>
