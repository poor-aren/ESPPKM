<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>ESP32 Simulator â€” Strict Session (Find-Only)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--pri:#3b4998;--bg:#f5f6fa;--text:#222;--muted:#6b7280;--ok:#16a34a;--warn:#ca8a04;--err:#dc2626}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1000px;margin:32px auto;padding:16px}
    .title{font-size:22px;font-weight:700;color:var(--pri);margin-bottom:12px}
    .card{background:#fff;border-radius:12px;box-shadow:0 6px 28px rgba(0,0,0,.08);padding:16px;margin-bottom:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;font-weight:700;color:#374151;display:block;margin:2px 0 6px}
    input,select{width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;outline:none}
    input:focus,select:focus{border-color:var(--pri)}
    .btn{appearance:none;border:none;border-radius:8px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn-pri{background:var(--pri);color:#fff}
    .btn-sec{background:#eef2ff;color:#1f2a52}
    .btn-danger{background:#fee2e2;color:#7f1d1d}
    .btn-ghost{background:#f3f4f6;color:#111827}
    .tag{display:inline-block;padding:3px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .tag-ok{background:#dcfce7;color:#166534}
    .tag-warn{background:#fef9c3;color:#854d0e}
    .tag-err{background:#fee2e2;color:#7f1d1d}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .log{background:#0b1220;color:#d1d5db;border-radius:10px;padding:10px;height:220px;overflow:auto;font-size:12px}
    .num input{text-align:right}
    .small{font-size:12px}
    .grid{display:grid;gap:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">ESP32 Simulator â€” Strict Session (Find-Only)</div>

    <!-- KONFIG -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div style="flex:1;min-width:260px;margin-right:10px">
          <label>API URL</label>
          <input id="apiUrl" placeholder="https://<apiId>.execute-api.<region>.amazonaws.com/<stage>">
        </div>
        <div style="flex:1;min-width:220px;margin-right:10px">
          <label>API Key</label>
          <input id="apiKey" placeholder="API key" class="mono">
        </div>
        <div style="width:160px">
          <label>Device ID</label>
          <input id="deviceId" placeholder="ESP01" value="ESP01">
        </div>
      </div>

      <div class="row" style="margin-top:10px;align-items:flex-end">
        <div style="flex:1;min-width:260px;margin-right:10px">
          <label>Session ID (otomatis, hanya jika OPEN ada)</label>
          <input id="sessionId" class="mono" placeholder="Nama_HP" readonly>
        </div>
        <div class="row">
          <button class="btn btn-ghost" id="btnDetect">ðŸ”Ž Cari Sesi Terbuka</button>
          <label class="row" style="gap:6px;margin-left:8px">
            <input type="checkbox" id="autoDetect" />
            <span class="small muted">Auto-cari tiap 2s</span>
          </label>
        </div>
        <div id="statusBadge" class="tag tag-err" style="margin-left:auto">NO SESSION</div>
      </div>
      <div class="small muted" style="margin-top:6px">
        * Simulator <b>tidak akan membuat sesi</b>. Jika belum ada sesi OPEN untuk Device ID ini, tombol kirim akan nonaktif.
        Buka sesi dari dashboard operator terlebih dahulu.
      </div>
    </div>

    <!-- KONTROL SENSOR & KIRIM -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div style="font-weight:800;color:#111827">Kontrol Sensor</div>
        <div class="row">
          <button class="btn btn-ghost" id="btnRandom">ðŸŽ² Random</button>
          <button class="btn btn-ghost" id="btnZero">â†º Reset</button>
        </div>
      </div>

      <div class="grid" style="grid-template-columns:repeat(4,minmax(0,1fr));margin-top:12px">
        <div class="num"><label>S1</label><input id="s1" type="number" min="0" max="300" value="0"></div>
        <div class="num"><label>S2</label><input id="s2" type="number" min="0" max="300" value="0"></div>
        <div class="num"><label>S3</label><input id="s3" type="number" min="0" max="300" value="0"></div>
        <div class="num"><label>S4</label><input id="s4" type="number" min="0" max="300" value="0"></div>
      </div>

      <div class="grid" style="grid-template-columns:repeat(3,minmax(0,1fr));margin-top:14px">
        <div>
          <label>Mode Kategori</label>
          <select id="mode">
            <option value="auto" selected>Otomatis (rata-rata)</option>
            <option value="manual">Manual</option>
          </select>
        </div>
        <div>
          <label>Kategori (kalau Manual)</label>
          <select id="category" disabled>
            <option>Rendah</option>
            <option>Sedang</option>
            <option>Tinggi</option>
          </select>
        </div>
        <div>
          <label>Interval Auto-Kirim (ms)</label>
          <input id="period" type="number" min="200" step="100" value="1200">
        </div>
      </div>

      <div class="row" style="margin-top:14px">
        <button class="btn btn-pri" id="btnSendOnce" disabled>Kirim Sekali</button>
        <button class="btn btn-sec" id="btnStart" disabled>Start Auto</button>
        <button class="btn btn-danger" id="btnStop" disabled>Stop</button>
      </div>

      <div class="small muted" style="margin-top:10px">
        Catatan: Simulator ini mengirim langsung ke <b>POST /session/{id}/result</b> agar dashboard bisa melihat hasil.
        Jalur IoT (sensor â†’ ingest) tetap dilakukan perangkat asli.
      </div>
    </div>

    <!-- LOG -->
    <div class="card">
      <div style="font-weight:800;color:#111827;margin-bottom:8px">Log</div>
      <div id="log" class="log mono"></div>
      <div class="row" style="margin-top:8px;justify-content:space-between">
        <div class="small muted">Terakhir: <span id="lastTs">-</span></div>
        <button class="btn btn-ghost" id="btnClearLog">Clear Log</button>
      </div>
    </div>
  </div>

<script>
/* ===================== DEFAULT (boleh ganti) ===================== */
const DEFAULTS = {
  apiUrl  : "https://8308ialq3d.execute-api.ap-southeast-1.amazonaws.com/tros-20251007091134-4239",
  apiKey  : "75179e4b24c0179f1806d2a18707e7cb",
  deviceId: "ESP01",
  sessionId: ""
};
/* ================================================================ */

const $ = sel => document.querySelector(sel);
const logBox = $('#log');
function log(...args){
  const t = new Date().toLocaleTimeString();
  const line = `[${t}] ` + args.map(x => typeof x==='string'?x:JSON.stringify(x)).join(' ');
  logBox.textContent += line + "\n";
  logBox.scrollTop = logBox.scrollHeight;
  $('#lastTs').textContent = t;
}
function saveLS(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function loadLS(k,fb){ try{ return JSON.parse(localStorage.getItem(k)) || fb }catch{ return fb } }

let cfg = loadLS('espSimCfgStrict', {...DEFAULTS});
let autoTimer = null, sendTimer = null;

function syncFormFromCfg(){
  $('#apiUrl').value = cfg.apiUrl;
  $('#apiKey').value = cfg.apiKey;
  $('#deviceId').value = cfg.deviceId;
  $('#sessionId').value = cfg.sessionId || '';
  updateUiEnabled();
}
function syncCfgFromForm(){
  cfg.apiUrl = $('#apiUrl').value.trim();
  cfg.apiKey = $('#apiKey').value.trim();
  cfg.deviceId = $('#deviceId').value.trim();
  // sessionId readonly
  saveLS('espSimCfgStrict', cfg);
  updateUiEnabled();
}

function setStatus(text, kind){
  const b = $('#statusBadge');
  b.textContent = text;
  b.className = 'tag ' + (kind==='ok'?'tag-ok':kind==='warn'?'tag-warn':'tag-err');
}
function updateUiEnabled(){
  const ready = Boolean(cfg.apiUrl && cfg.apiKey && cfg.deviceId && cfg.sessionId);
  $('#btnSendOnce').disabled = !ready;
  $('#btnStart').disabled    = !ready || Boolean(sendTimer);
  $('#btnStop').disabled     = !sendTimer;
  if (ready) setStatus('READY', 'ok');
  else if (cfg.apiUrl && cfg.apiKey && cfg.deviceId) setStatus('NO SESSION', 'err');
  else setStatus('DISCONNECTED','err');
}

async function callAPI(path, method='GET', body=null){
  const url = cfg.apiUrl.replace(/\/+$/,'') + path;
  const opt = { method, headers: {'content-type':'application/json','x-api-key':cfg.apiKey} };
  if (body) opt.body = JSON.stringify(body);
  const res = await fetch(url, opt);
  if (!res.ok){
    const txt = await res.text().catch(()=>res.statusText);
    throw new Error(`${method} ${path} -> ${res.status} ${txt}`);
  }
  return res.json();
}

/* --------- STRICT: hanya cari sesi OPEN, tidak pernah membuat ---------- */
async function findOpenSessionIdForDevice(deviceId){
  const { patients = [] } = await callAPI('/history','GET');
  const open = patients.filter(p => p.status === 'OPEN' && p.device_id === deviceId);
  if (!open.length) return null;
  open.sort((a,b) => ((b.lastResultTimestamp||b.sessionStart||'').localeCompare(a.lastResultTimestamp||a.sessionStart||'')));
  return open[0].id;
}

async function detectSession(){
  try{
    syncCfgFromForm();
    if (!cfg.apiUrl || !cfg.apiKey || !cfg.deviceId){
      log('âš ï¸ Lengkapi API URL, API Key, dan Device ID dulu.');
      return;
    }
    setStatus('SEARCHINGâ€¦','warn');
    const sid = await findOpenSessionIdForDevice(cfg.deviceId);
    if (sid){
      cfg.sessionId = sid;
      $('#sessionId').value = sid;
      saveLS('espSimCfgStrict', cfg);
      updateUiEnabled();
      log('âœ… OPEN session ditemukan:', sid);
    } else {
      cfg.sessionId = '';
      $('#sessionId').value = '';
      saveLS('espSimCfgStrict', cfg);
      updateUiEnabled();
      log('â›” Tidak ada sesi OPEN untuk device', cfg.deviceId, 'â€” buka sesi dari dashboard.');
    }
  }catch(e){
    log('âŒ detect error:', String(e));
    setStatus('ERROR','err');
  }
}

/* --------------------- Kirim â€œresultâ€ (simulasi) ---------------------- */
function readSensors(){
  return [$('#s1').value,$('#s2').value,$('#s3').value,$('#s4').value].map(x=>Number(x||0));
}
function inferCategory(values){
  const avg = values.reduce((a,b)=>a+b,0)/Math.max(values.length,1);
  let category='Rendah';
  if (avg>=80) category='Tinggi';
  else if (avg>=40) category='Sedang';
  const confidence = Math.min(0.95, 0.6 + (avg/200));
  return { category, confidence: Number(confidence.toFixed(2)) };
}

async function sendOnce(){
  try{
    if (!cfg.sessionId){
      log('â›” Tidak ada sesi OPEN â€” kirim dibatalkan.');
      return;
    }
    const values = readSensors();
    let cat, conf;
    if ($('#mode').value === 'manual'){
      cat = $('#category').value; conf = 0.8;
    } else {
      const x = inferCategory(values); cat = x.category; conf = x.confidence;
    }
    const payload = { category:cat, confidence:conf, sensor_values:values, device_id:cfg.deviceId };
    const r = await callAPI(`/session/${encodeURIComponent(cfg.sessionId)}/result`, 'POST', payload);
    log('ðŸ“¤ POST /result OK â†’', payload);
    return r;
  }catch(err){
    log('âŒ Send failed:', String(err));
  }
}

/* ----------------------------- Auto-send ------------------------------ */
function startAuto(){
  if (sendTimer || !cfg.sessionId) return;
  const ms = Math.max(200, Number($('#period').value||1200));
  $('#btnStart').disabled = true; $('#btnStop').disabled = false;
  sendTimer = setInterval(sendOnce, ms);
  log('â–¶ Auto-send started every', ms, 'ms');
}
function stopAuto(){
  if (!sendTimer) return;
  clearInterval(sendTimer); sendTimer = null;
  $('#btnStart').disabled = !cfg.sessionId; $('#btnStop').disabled = true;
  log('â¸ Auto-send stopped');
}

/* ------------------------------- UI HOOKS ----------------------------- */
['#apiUrl','#apiKey','#deviceId'].forEach(sel=>{
  $(sel).addEventListener('change', ()=>{ syncCfgFromForm(); });
});
$('#btnDetect').addEventListener('click', detectSession);

$('#autoDetect').addEventListener('change', (e)=>{
  if (e.target.checked){
    if (autoTimer) clearInterval(autoTimer);
    autoTimer = setInterval(detectSession, 2000);
    detectSession();
    log('ðŸ” Auto-detect aktif (2s).');
  } else {
    if (autoTimer) clearInterval(autoTimer);
    autoTimer = null;
    log('â¹ Auto-detect dimatikan.');
  }
});

$('#mode').addEventListener('change', ()=>{
  const manual = $('#mode').value === 'manual';
  $('#category').disabled = !manual;
});

$('#btnRandom').addEventListener('click', ()=>{
  const r = () => Math.floor(Math.random()*101);
  $('#s1').value=r();$('#s2').value=r();$('#s3').value=r();$('#s4').value=r();
});
$('#btnZero').addEventListener('click', ()=>{
  $('#s1').value=0;$('#s2').value=0;$('#s3').value=0;$('#s4').value=0;
});

$('#btnSendOnce').addEventListener('click', sendOnce);
$('#btnStart').addEventListener('click', startAuto);
$('#btnStop').addEventListener('click', stopAuto);
$('#btnClearLog').addEventListener('click', ()=>{ logBox.textContent=''; });

document.addEventListener('DOMContentLoaded', ()=>{
  // Prefill dengan nilai yang sudah kamu pakai sebelumnya
  syncFormFromCfg();

  // Default ke nilai yang sudah terbukti di tes kamu
  if (!cfg.apiUrl)  cfg.apiUrl  = DEFAULTS.apiUrl;
  if (!cfg.apiKey)  cfg.apiKey  = DEFAULTS.apiKey;
  if (!cfg.deviceId)cfg.deviceId= DEFAULTS.deviceId;
  syncFormFromCfg(); saveLS('espSimCfgStrict', cfg);

  // Auto-detect sekali saat load (tanpa bikin sesi)
  detectSession();
});
</script>
</body>
</html>
