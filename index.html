<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Simulator - Sunstone PPOK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .oled-screen {
            background: #1a1a2e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 20px;
            border-radius: 8px;
            min-height: 200px;
            box-shadow: inset 0 0 20px rgba(0, 255, 0, 0.2);
        }
        .rocker-switch {
            width: 80px;
            height: 40px;
            background: #e0e0e0;
            border-radius: 20px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }
        .rocker-switch.active {
            background: #4CAF50;
        }
        .rocker-switch::after {
            content: '';
            position: absolute;
            width: 32px;
            height: 32px;
            background: white;
            border-radius: 50%;
            top: 4px;
            left: 4px;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .rocker-switch.active::after {
            left: 44px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen py-8">
        <div class="max-w-4xl mx-auto">
            
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700">
                            <strong>PENTING:</strong> Pastikan sudah membuka sesi di website utama terlebih dahulu!
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">ESP32 Simulator</h1>
                        <p class="text-gray-600 mt-1">Sunstone PPOK Detection System</p>
                    </div>
                    <div>
                        <div class="flex items-center space-x-2 mb-2">
                            <div id="wifiStatus" class="w-4 h-4 bg-green-500 rounded-full"></div>
                            <span class="text-sm text-gray-600">WiFi Connected</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div id="awsStatus" class="w-4 h-4 bg-blue-500 rounded-full"></div>
                            <span class="text-sm text-gray-600">AWS Ready</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">ESP32 Device</h2>
                    
                    <div class="oled-screen mb-6">
                        <div id="oledDisplay" class="text-sm leading-relaxed">
                            <p>SUNSTONE PPOK v1.0</p>
                            <p>─────────────────────</p>
                            <p>WiFi: SUNSTONE</p>
                            <p>AWS: Connected</p>
                            <p></p>
                            <p>Sistema siap</p>
                            <p>Tekan rocker switch...</p>
                        </div>
                    </div>

                    <div class="text-center mb-4">
                        <p class="text-sm text-gray-600 mb-2">Rocker Switch</p>
                        <div id="rockerSwitch" class="rocker-switch mx-auto" onclick="toggleRockerSwitch()"></div>
                        <p id="switchStatus" class="text-xs text-gray-500 mt-2">OFF</p>
                    </div>

                    <div id="sessionWarning" class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4 hidden">
                        <p class="text-sm text-red-700">Tidak ada sesi aktif! Buka sesi di website terlebih dahulu.</p>
                    </div>

                    <div id="sessionActive" class="bg-green-50 border border-green-200 rounded-lg p-3 hidden">
                        <p class="text-sm text-green-700">Sesi aktif terdeteksi! Siap mengirim data.</p>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Sensor Controls</h2>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            MG811 (CO2): <span id="mg811_value" class="font-bold text-blue-600">300</span>
                        </label>
                        <input type="range" id="mg811" min="100" max="500" value="300" 
                            class="w-full" oninput="updateSensorDisplay()">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>100</span>
                            <span>500</span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            MQ7 (CO): <span id="mq7_value" class="font-bold text-blue-600">70</span>
                        </label>
                        <input type="range" id="mq7" min="30" max="150" value="70" 
                            class="w-full" oninput="updateSensorDisplay()">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>30</span>
                            <span>150</span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            MQ3 (Alcohol): <span id="mq3_value" class="font-bold text-blue-600">50</span>
                        </label>
                        <input type="range" id="mq3" min="20" max="100" value="50" 
                            class="w-full" oninput="updateSensorDisplay()">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>20</span>
                            <span>100</span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            MQ135 (Air Quality): <span id="mq135_value" class="font-bold text-blue-600">200</span>
                        </label>
                        <input type="range" id="mq135" min="100" max="400" value="200" 
                            class="w-full" oninput="updateSensorDisplay()">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>100</span>
                            <span>400</span>
                        </div>
                    </div>

                    <div class="mt-6">
                        <p class="text-sm font-medium text-gray-700 mb-2">Preset Scenarios</p>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setScenario('rendah')" class="bg-green-100 text-green-700 px-3 py-2 rounded text-sm hover:bg-green-200">
                                Risiko Rendah
                            </button>
                            <button onclick="setScenario('sedang')" class="bg-yellow-100 text-yellow-700 px-3 py-2 rounded text-sm hover:bg-yellow-200">
                                Risiko Sedang
                            </button>
                            <button onclick="setScenario('tinggi')" class="bg-red-100 text-red-700 px-3 py-2 rounded text-sm hover:bg-red-200">
                                Risiko Tinggi
                            </button>
                        </div>
                    </div>
                </div>

            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Activity Log</h2>
                <div id="logPanel" class="bg-gray-50 rounded p-4 max-h-64 overflow-y-auto font-mono text-xs space-y-1">
                    <p class="text-green-600">[System] ESP32 Simulator initialized</p>
                    <p class="text-green-600">[WiFi] Connected to SUNSTONE</p>
                    <p class="text-blue-600">[AWS] Ready to publish data</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        const CONFIG = {
            API_ENDPOINT: 'https://b0gtlz3zrj.execute-api.ap-southeast-1.amazonaws.com/prod',
            DEVICE_ID: 'ESP01',
        };

        let rockerSwitchActive = false;
        let publishInterval = null;
        let countdownTimer = null;
        let sessionCheckInterval = null;
        let hasActiveSession = false;

        async function checkActiveSession() {
            try {
                const response = await fetch(`${CONFIG.API_ENDPOINT}/sessions`);
                const sessions = await response.json();
                
                hasActiveSession = sessions.some(s => s.status === 'OPEN');
                
                if (hasActiveSession) {
                    document.getElementById('sessionWarning').classList.add('hidden');
                    document.getElementById('sessionActive').classList.remove('hidden');
                    addLog('[Session] Active session detected', 'green');
                } else {
                    document.getElementById('sessionWarning').classList.remove('hidden');
                    document.getElementById('sessionActive').classList.add('hidden');
                }
            } catch (error) {
                addLog('[Error] Cannot check session status', 'red');
            }
        }

        function toggleRockerSwitch() {
            if (!hasActiveSession) {
                alert('Tidak ada sesi aktif!\n\nSilakan buka sesi di website utama terlebih dahulu (Tab "Sesi Baru")');
                return;
            }

            rockerSwitchActive = !rockerSwitchActive;
            const rocker = document.getElementById('rockerSwitch');
            const status = document.getElementById('switchStatus');
            
            if (rockerSwitchActive) {
                rocker.classList.add('active');
                status.textContent = 'ON';
                startCountdown();
            } else {
                rocker.classList.remove('active');
                status.textContent = 'OFF';
                stopPublishing();
            }
        }

        function startCountdown() {
            let countdown = 5;
            
            updateOLED([
                'SUNSTONE PPOK v1.0',
                '─────────────────────',
                'Bersiap...',
                '',
                `Starting in ${countdown}s`,
                '',
                'Please wait...'
            ]);
            
            addLog('[Switch] Rocker switch activated', 'blue');
            addLog(`[System] Countdown: ${countdown} seconds`, 'yellow');
            
            countdownTimer = setInterval(() => {
                countdown--;
                
                updateOLED([
                    'SUNSTONE PPOK v1.0',
                    '─────────────────────',
                    'Bersiap...',
                    '',
                    `Starting in ${countdown}s`,
                    '',
                    'Please wait...'
                ]);
                
                addLog(`[System] Countdown: ${countdown} seconds`, 'yellow');
                
                if (countdown <= 0) {
                    clearInterval(countdownTimer);
                    startPublishing();
                }
            }, 1000);
        }

        function startPublishing() {
            addLog('[System] Starting sensor data transmission', 'green');
            
            updateOLED([
                'SUNSTONE PPOK v1.0',
                '─────────────────────',
                'Status: ACTIVE',
                'Publishing data...',
                '',
                'Sensor readings:',
                getSensorReadingText()
            ]);
            
            publishSensorData();
            publishInterval = setInterval(publishSensorData, 2000);
        }

        function stopPublishing() {
            if (publishInterval) {
                clearInterval(publishInterval);
                publishInterval = null;
            }
            
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            
            updateOLED([
                'SUNSTONE PPOK v1.0',
                '─────────────────────',
                'WiFi: SUNSTONE',
                'Status: Stopped',
                '',
                'Sistema siap',
                'Tekan rocker switch...'
            ]);
            
            addLog('[System] Stopped sensor transmission', 'yellow');
        }

        async function publishSensorData() {
            const mg811 = parseInt(document.getElementById('mg811').value);
            const mq7 = parseInt(document.getElementById('mq7').value);
            const mq3 = parseInt(document.getElementById('mq3').value);
            const mq135 = parseInt(document.getElementById('mq135').value);
            
            const payload = {
                device_id: CONFIG.DEVICE_ID,
                sensors: {
                    raw_mg811: mg811,
                    raw_mq7: mq7,
                    raw_mq3: mq3,
                    raw_mq135: mq135
                }
            };
            
            addLog(`[MQTT] Publishing to devices/${CONFIG.DEVICE_ID}/sensor`, 'blue');
            addLog(`[Data] MG811:${mg811} MQ7:${mq7} MQ3:${mq3} MQ135:${mq135}`, 'gray');
            
            updateOLED([
                'SUNSTONE PPOK v1.0',
                '─────────────────────',
                'Status: SENDING',
                '',
                getSensorReadingText(),
                '',
                'Transmitting...'
            ]);
            
            try {
                const response = await fetch(`${CONFIG.API_ENDPOINT}/simulator/publish`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                addLog('[AWS] Data sent to IoT Core', 'green');
                
                updateOLED([
                    'SUNSTONE PPOK v1.0',
                    '─────────────────────',
                    'Status: SENT',
                    '',
                    getSensorReadingText(),
                    '',
                    'Waiting result...'
                ]);
            } catch (error) {
                addLog('[Error] Failed to send: ' + error.message, 'red');
            }
        }

        function setScenario(risk) {
            switch(risk) {
                case 'rendah':
                    document.getElementById('mg811').value = 180;
                    document.getElementById('mq7').value = 45;
                    document.getElementById('mq3').value = 30;
                    document.getElementById('mq135').value = 120;
                    break;
                case 'sedang':
                    document.getElementById('mg811').value = 300;
                    document.getElementById('mq7').value = 80;
                    document.getElementById('mq3').value = 55;
                    document.getElementById('mq135').value = 200;
                    break;
                case 'tinggi':
                    document.getElementById('mg811').value = 420;
                    document.getElementById('mq7').value = 120;
                    document.getElementById('mq3').value = 85;
                    document.getElementById('mq135').value = 330;
                    break;
            }
            updateSensorDisplay();
            addLog(`[Scenario] Loaded ${risk} risk preset`, 'purple');
        }

        function updateSensorDisplay() {
            document.getElementById('mg811_value').textContent = document.getElementById('mg811').value;
            document.getElementById('mq7_value').textContent = document.getElementById('mq7').value;
            document.getElementById('mq3_value').textContent = document.getElementById('mq3').value;
            document.getElementById('mq135_value').textContent = document.getElementById('mq135').value;
        }

        function getSensorReadingText() {
            const mg811 = document.getElementById('mg811').value;
            const mq7 = document.getElementById('mq7').value;
            const mq3 = document.getElementById('mq3').value;
            const mq135 = document.getElementById('mq135').value;
            return `MG811:${mg811} MQ7:${mq7}\nMQ3:${mq3} MQ135:${mq135}`;
        }

        function updateOLED(lines) {
            document.getElementById('oledDisplay').innerHTML = lines.map(line => `<p>${line}</p>`).join('');
        }

        function addLog(message, color = 'gray') {
            const logPanel = document.getElementById('logPanel');
            const timestamp = new Date().toLocaleTimeString('id-ID');
            const colorClass = {
                'blue': 'text-blue-600',
                'green': 'text-green-600',
                'yellow': 'text-yellow-600',
                'red': 'text-red-600',
                'purple': 'text-purple-600',
                'gray': 'text-gray-600'
            };
            
            const logEntry = document.createElement('p');
            logEntry.className = colorClass[color] || 'text-gray-600';
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logPanel.appendChild(logEntry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        window.addEventListener('load', () => {
            updateSensorDisplay();
            checkActiveSession();
            sessionCheckInterval = setInterval(checkActiveSession, 5000);
            addLog('[Info] Checking for active session...', 'blue');
        });
    </script>
</body>
</html>
