<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ESP32 Simulator – SUNSTONE</title>
  <style>
    :root{--pri:#3b4998;--bg:#f5f6fa;--mut:#778;--ok:#1e9e5a;--err:#c62828}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:Segoe UI,system-ui,Arial,sans-serif;color:#222}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    .card{background:#fff;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.08);overflow:hidden}
    .head{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #eee}
    h1{font-size:20px;margin:0;color:var(--pri)} .tag{font:600 12px/1.6 system-ui;color:#fff;background:var(--pri);padding:4px 10px;border-radius:999px}
    .body{padding:16px 20px}
    .grid{display:grid;gap:14px} .g2{grid-template-columns:repeat(2,minmax(0,1fr))} .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    label{font-size:12px;color:#444;font-weight:600;margin-bottom:6px;display:block}
    input,select{width:100%;padding:10px 12px;border:2px solid #e3e5ef;border-radius:8px;font-size:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{appearance:none;border:0;background:var(--pri);color:#fff;padding:10px 14px;border-radius:8px;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.alt{background:#e9ecff;color:#253;margin-left:6px;color:#1b2a6b}
    .btn.ghost{background:#fff;border:2px solid #dfe3f5;color:#1b2a6b}
    .btn.ok{background:var(--ok)} .btn.err{background:var(--err)}
    .mut{color:var(--mut);font-size:12px}
    .log{font:12px/1.5 ui-monospace,Consolas,monospace;background:#0e0f14;color:#dce3ff;padding:12px;border-radius:10px;height:220px;overflow:auto}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#f3f5ff;border:1px solid #dee5ff;color:#1b2a6b;padding:8px 10px;border-radius:12px}
    .sep{height:1px;background:#eee;margin:16px -20px}
    small.code{font-family:ui-monospace,Consolas,monospace;background:#f4f5f9;border:1px solid #e7e9f3;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <h1>ESP32 Simulator</h1>
        <span class="tag">Testing tool • tidak mengubah UI utama</span>
      </div>
      <div class="body grid g2">
        <!-- KONFIGURASI -->
        <div>
          <h3 style="margin:0 0 8px;color:#1b2a6b">Konfigurasi AWS</h3>
          <div class="grid">
            <div>
              <label>API URL</label>
              <input id="apiUrl" value="https://8308ialq3d.execute-api.ap-southeast-1.amazonaws.com/tros-20251007091134-4239">
            </div>
            <div>
              <label>API Key</label>
              <input id="apiKey" value="75179e4b24c0179f1806d2a18707e7cb">
            </div>
            <div>
              <label>Device ID</label>
              <input id="deviceId" value="ESP01">
            </div>
            <div>
              <label>Session ID (nama_hp)</label>
              <input id="sessionId" placeholder="Contoh: Smoke_001">
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn ghost" id="btnSaveCfg">Simpan Konfig</button>
            <button class="btn alt" id="btnOpenSession">Buka Sesi Cepat</button>
          </div>
          <p class="mut" style="margin-top:6px">
            * “Buka Sesi Cepat” membuat sesi dengan <small class="code">name=Sim</small>, <small class="code">phone=Now</small> dan memetakan device ID di atas.
          </p>
        </div>

        <!-- SENSOR PANEL -->
        <div>
          <h3 style="margin:0 0 8px;color:#1b2a6b">Nilai Sensor</h3>
          <div class="grid g2">
            <div><label>S1</label><input id="s1" type="number" step="1" value="12"></div>
            <div><label>S2</label><input id="s2" type="number" step="1" value="34"></div>
            <div><label>S3</label><input id="s3" type="number" step="1" value="56"></div>
            <div><label>S4</label><input id="s4" type="number" step="1" value="78"></div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn ghost" id="btnRandom">Acak</button>
            <span class="pill"><span id="avgText">rata2: 45.0</span></span>
          </div>
          <div class="sep"></div>
          <div class="grid g2">
            <div>
              <label>Kategori</label>
              <select id="category">
                <option value="auto" selected>Auto (berdasar rata-rata)</option>
                <option value="Rendah">Rendah</option>
                <option value="Sedang">Sedang</option>
                <option value="Tinggi">Tinggi</option>
              </select>
            </div>
            <div>
              <label>Confidence (0–1, kosong=auto)</label>
              <input id="conf" type="number" step="0.01" min="0" max="1" placeholder="mis. 0.82">
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn ok" id="btnSendOnce">Kirim Sekali → /result</button>
            <button class="btn" id="btnAuto">Mulai Auto Stream</button>
            <button class="btn err" id="btnStop" disabled>Stop</button>
          </div>
          <p class="mut" style="margin-top:8px">
            Sim ini **mengirim langsung ke <small class="code">POST /session/{id}/result</small>** (tanpa IoT Core).
            Dashboard-mu tetap bisa melihat **/latest** & **riwayat**.
          </p>
        </div>

        <!-- LOG -->
        <div class="g3" style="grid-column:1/-1">
          <div style="grid-column:1/-1">
            <h3 style="margin:4px 0 8px;color:#1b2a6b">Log</h3>
            <div id="log" class="log"></div>
          </div>
        </div>
      </div>
    </div>

    <p class="mut" style="margin-top:10px">
      Catatan: kalau kamu benar-benar mau publish ke **AWS IoT Core** via browser, kita perlu setup Cognito Identity + IoT policy
      lalu pakai <small class="code">aws-iot-device-sdk-js-v2</small> (MQTT over WebSocket). Itu bisa, tapi di-setup nanti saja.
    </p>
  </div>

<script>
/* ===== Helpers kecil ===== */
const $ = s => document.querySelector(s);
const logBox = $('#log');
const log = (...msg) => {
  const line = `[${new Date().toLocaleTimeString()}] ` + msg.join(' ');
  const div = document.createElement('div'); div.textContent = line;
  logBox.appendChild(div); logBox.scrollTop = logBox.scrollHeight;
};
const saveLS = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
const getLS  = (k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d } };

/* ===== State & Config ===== */
const cfg = getLS('espSimCfg', {
  apiUrl: $('#apiUrl').value.trim(),
  apiKey: $('#apiKey').value.trim(),
  deviceId: $('#deviceId').value.trim(),
  sessionId: $('#sessionId').value.trim()
});
function applyCfgToForm(){
  $('#apiUrl').value = cfg.apiUrl;
  $('#apiKey').value = cfg.apiKey;
  $('#deviceId').value = cfg.deviceId;
  $('#sessionId').value = cfg.sessionId;
}
applyCfgToForm();

/* ===== Hit API helper ===== */
async function callAPI(path, method='GET', body=null){
  const url = cfg.apiUrl.replace(/\/+$/,'') + path;
  const opt = { method, headers: { 'content-type':'application/json', 'x-api-key': cfg.apiKey } };
  if(body) opt.body = JSON.stringify(body);
  const res = await fetch(url, opt);
  if(!res.ok){
    const t = await res.text().catch(()=>''+res.status);
    throw new Error(`${method} ${path} → ${res.status} ${t}`);
  }
  return res.json();
}

/* ===== Category/Confidence “auto” (sama seperti UI-mu) ===== */
function autoCategory(values){
  const n = (values||[]).length || 1;
  const avg = (values||[]).reduce((a,b)=>a+Number(b||0),0)/n;
  let cat = 'Rendah';
  if(avg>=80) cat='Tinggi';
  else if(avg>=40) cat='Sedang';
  const conf = Math.min(0.95, 0.6 + (avg/200));
  return { cat, conf: Number(conf.toFixed(2)), avg };
}
function readValues(){
  const vals = [$('#s1').value,$('#s2').value,$('#s3').value,$('#s4').value].map(v=>Number(v||0));
  const {cat, conf, avg} = autoCategory(vals);
  $('#avgText').textContent = `rata2: ${avg.toFixed(1)}`;
  return { vals, cat, conf };
}
['#s1','#s2','#s3','#s4'].forEach(sel=>{
  $(sel).addEventListener('input', readValues);
});
readValues();

/* ===== Actions ===== */
$('#btnSaveCfg').addEventListener('click', ()=>{
  cfg.apiUrl   = $('#apiUrl').value.trim();
  cfg.apiKey   = $('#apiKey').value.trim();
  cfg.deviceId = $('#deviceId').value.trim();
  cfg.sessionId= $('#sessionId').value.trim();
  saveLS('espSimCfg', cfg);
  log('✅ Konfig disimpan.');
});

$('#btnRandom').addEventListener('click', ()=>{
  const rand = ()=> Math.floor(Math.random()*120);
  $('#s1').value = rand(); $('#s2').value = rand(); $('#s3').value = rand(); $('#s4').value = rand();
  readValues();
});

/* Buka sesi cepat: name=Sim, phone=Now, map ke deviceId */
$('#btnOpenSession').addEventListener('click', async ()=>{
  try{
    cfg.apiUrl   = $('#apiUrl').value.trim();
    cfg.apiKey   = $('#apiKey').value.trim();
    cfg.deviceId = $('#deviceId').value.trim();
    const r = await callAPI('/session','POST',{ name:'Sim', phone:'Now', device_id: cfg.deviceId });
    cfg.sessionId = r.id; $('#sessionId').value = cfg.sessionId; saveLS('espSimCfg',cfg);
    log('✅ Sesi dibuat:', r.id);
  }catch(e){ log('❌ Gagal buat sesi:', e.message); alert(e.message); }
});

/* Kirim sekali ke /result */
async function publishOnce(){
  if(!cfg.sessionId){ alert('Isi Session ID dulu (atau klik Buka Sesi Cepat).'); return; }
  const {vals, cat, conf} = readValues();
  let category = $('#category').value;
  if(category==='auto') category = cat;
  let confidence = $('#conf').value.trim();
  confidence = confidence ? Number(confidence) : conf;

  const payload = {
    category, confidence,
    sensor_values: vals,
    device_id: cfg.deviceId
  };

  try{
    const r = await callAPI(`/session/${encodeURIComponent(cfg.sessionId)}/result`, 'POST', payload);
    log('➡️  POST /result', JSON.stringify(payload), '→', JSON.stringify(r));
    // cek latest biar kelihatan
    const latest = await callAPI(`/session/${encodeURIComponent(cfg.sessionId)}/latest`, 'GET');
    log('⬅️  GET /latest →', JSON.stringify(latest));
  }catch(e){
    log('❌ Gagal kirim:', e.message);
    alert(e.message);
  }
}
$('#btnSendOnce').addEventListener('click', publishOnce);

/* Auto stream */
let timer = null;
$('#btnAuto').addEventListener('click', ()=>{
  if(timer) return;
  timer = setInterval(()=>{
    // kalau confidence kosong → auto; kalau diisi → pakai nilai user
    publishOnce();
    // opsi: acak tiap tick biar jalan terus
    $('#btnRandom').click();
  }, 1200);
  $('#btnStop').disabled = false;
  log('▶️ Auto stream dimulai (1.2s).');
});
$('#btnStop').addEventListener('click', ()=>{
  if(timer){ clearInterval(timer); timer=null; log('⏹️ Auto stream dihentikan.'); }
  $('#btnStop').disabled = true;
});

/* Restore config dari localStorage saat awal */
document.addEventListener('DOMContentLoaded', ()=>{
  // kalau sebelumnya sudah simpan sessionId, langsung pakai
  if(cfg.sessionId) log('ℹ️ Session aktif:', cfg.sessionId);
});
</script>
</body>
</html>
