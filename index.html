<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ESP32 Simulator</title>
  <script src="https://unpkg.com/mqtt@5.3.5/dist/mqtt.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Courier New', monospace; background:#1a1a2e; color:#eee; }
    .wrap { max-width:600px; margin:40px auto; padding:25px; background:#16213e; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.4); }
    h2 { color:#0f3; margin-bottom:20px; text-align:center; }
    .info { display:flex; justify-content:space-between; margin-bottom:15px; padding:12px; background:#0f1419; border-radius:6px; }
    .info .label { color:#888; font-size:13px; }
    .info .value { color:#0f3; font-weight:600; }
    #oled { background:#000; color:#0f3; padding:15px; border-radius:8px; min-height:120px; font-size:13px; line-height:1.6; margin-bottom:20px; white-space:pre-wrap; border:2px solid #0f3; }
    .controls { display:flex; gap:10px; flex-wrap:wrap; }
    .btn { flex:1; min-width:140px; padding:12px; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:14px; transition:all 0.2s; }
    .btn:disabled { opacity:0.4; cursor:not-allowed; }
    .btn.start { background:#0f3; color:#000; }
    .btn.start:hover:not(:disabled) { background:#0d0; }
    .btn.stop { background:#f33; color:#fff; }
    .btn.stop:hover:not(:disabled) { background:#d00; }
    .btn.cal { background:#fa0; color:#000; }
    .btn.cal:hover:not(:disabled) { background:#f80; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>üîå ESP32 Simulator</h2>
    
    <div class="info">
      <div><div class="label">Device ID</div><div class="value" id="dev">ESP01</div></div>
      <div><div class="label">MQTT Status</div><div class="value" id="st">Connecting‚Ä¶</div></div>
    </div>

    <pre id="oled">üîÑ Booting ESP32‚Ä¶</pre>

    <div class="controls">
      <button id="startBtn" class="btn start" disabled>‚ñ∂Ô∏è Mulai</button>
      <button id="stopBtn" class="btn stop" disabled>‚è∏Ô∏è Stop</button>
      <button id="calBtn" class="btn cal" disabled>üîß Kalibrasi</button>
    </div>
  </div>

  <script>
  const CONFIG = {
    broker: 'wss://broker.hivemq.com:8884/mqtt',
    clientId: 'esp32_sim_' + Math.random().toString(16).slice(2),
    topics: { sensor: 'sunstone/esp32/ESP01/sensor', cmd: 'sunstone/esp32/ESP01/cmd' }
  };

  let mqttClient, timer, sessionOpen = false;

  function logOLED(t) {
    const lines = oled.textContent.split('\n');
    lines.push(`[${new Date().toLocaleTimeString()}] ${t}`);
    oled.textContent = lines.slice(-8).join('\n'); // Keep last 8 lines
  }

  function connectMQTT() {
    mqttClient = mqtt.connect(CONFIG.broker, { clientId: CONFIG.clientId, clean: true, reconnectPeriod: 3000 });
    mqttClient.on('connect', () => {
      st.textContent = 'Connected';
      st.style.color = '#0f3';
      mqttClient.subscribe(CONFIG.topics.cmd);
      logOLED('‚úÖ MQTT Connected');
      logOLED('‚è≥ Menunggu sesi‚Ä¶');
    });

    mqttClient.on('message', (topic, payload) => {
      const msg = JSON.parse(payload.toString() || '{}');
      if (msg.action === 'session_ready') {
        sessionOpen = true;
        startBtn.disabled = false;
        calBtn.disabled = false;
        logOLED(`üü¢ SESI SIAP`);
        logOLED(`üë§ Pasien: ${msg.patient_name || '-'}`);
      } else if (msg.action === 'no_session') {
        sessionOpen = false;
        startBtn.disabled = true;
        stopPublish();
        logOLED('üî¥ Tidak ada sesi terbuka');
      } else if (msg.action === 'close_session') {
        sessionOpen = false;
        stopPublish();
        logOLED('üî¥ Sesi ditutup oleh web');
      }
    });

    mqttClient.on('close', () => {
      st.textContent = 'Disconnected';
      st.style.color = '#f33';
      stopPublish();
      startBtn.disabled = true;
      stopBtn.disabled = true;
      calBtn.disabled = true;
      logOLED('‚ùå MQTT Disconnected');
    });
  }

  function rand(n1, n2) { return Math.round(n1 + (n2 - n1) * Math.random()); }

  function publishOnce() {
    if (!sessionOpen) return;
    const data = {
      device_id: 'ESP01',
      ts: new Date().toISOString(),
      mg811: rand(150, 600),
      mq7: rand(50, 400),
      mq3: rand(30, 300),
      mq135: rand(60, 500)
    };
    mqttClient.publish(CONFIG.topics.sensor, JSON.stringify(data));
    logOLED(`üì° Sent: ${data.mg811}|${data.mq7}|${data.mq3}|${data.mq135}`);
  }

  function startPublish() {
    if (!sessionOpen) return logOLED('‚ö†Ô∏è Tidak ada sesi!');
    stopPublish();
    timer = setInterval(publishOnce, 2000);
    stopBtn.disabled = false;
    logOLED('‚ñ∂Ô∏è Mulai publish data‚Ä¶');
  }

  function stopPublish() {
    if (timer) { clearInterval(timer); timer = null; }
    stopBtn.disabled = true;
    logOLED('‚è∏Ô∏è Publish dihentikan');
  }

  startBtn.onclick = startPublish;
  stopBtn.onclick = stopPublish;
  calBtn.onclick = () => logOLED('üîß Kalibrasi 5s‚Ä¶ (simulasi)');

  window.addEventListener('load', () => setTimeout(connectMQTT, 800));
  window.addEventListener('beforeunload', () => { stopPublish(); if (mqttClient) mqttClient.end(); });
  </script>
</body>
</html>
