<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ESP32 Simulator (Publish via API → IoT)</title>
<style>
  body{font-family:Segoe UI,system-ui,Arial,sans-serif;background:#0f172a;color:#e5e7eb;margin:0;padding:24px}
  .card{max-width:720px;margin:0 auto;background:#111827;border:1px solid #1f2937;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.4)}
  .hdr{padding:18px 20px;border-bottom:1px solid #1f2937;display:flex;justify-content:space-between;align-items:center}
  .hdr h1{font-size:18px;margin:0;color:#a5b4fc}
  .cnt{padding:20px}
  .row{display:flex;gap:12px;margin-bottom:12px}
  .col{flex:1}
  label{font-size:12px;color:#94a3b8;display:block;margin-bottom:6px}
  input[type=number]{width:100%;padding:10px;border-radius:10px;border:1px solid #374151;background:#0b1220;color:#e5e7eb}
  .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn-primary{background:#6366f1;color:#fff}
  .btn-line{background:#0b1220;border:1px solid #334155;color:#e5e7eb}
  .muted{color:#94a3b8}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .log{background:#0b1220;border:1px dashed #334155;border-radius:10px;padding:12px;max-height:220px;overflow:auto;font-family:ui-monospace,Consolas,monospace;font-size:12px}
  .ok{color:#22c55e}.warn{color:#f59e0b}.err{color:#ef4444}
</style>
</head>
<body>
<div class="card">
  <div class="hdr">
    <h1>ESP32 Simulator</h1>
    <div class="muted" id="status">Init…</div>
  </div>
  <div class="cnt">
    <!-- CONFIG -->
    <div class="grid" style="margin-bottom:8px">
      <div>
        <label>API URL</label>
        <input id="apiUrl" value="https://8308ialq3d.execute-api.ap-southeast-1.amazonaws.com/tros-20251007091134-4239">
      </div>
      <div>
        <label>API Key</label>
        <input id="apiKey" value="75179e4b24c0179f1806d2a18707e7cb">
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>Device ID</label>
        <input id="deviceId" value="ESP01">
      </div>
      <div class="col">
        <label>OPEN Session ID (auto)</label>
        <input id="sessionId" placeholder="(auto-lookup)" readonly>
      </div>
    </div>

    <hr style="border:0;border-top:1px solid #1f2937;margin:14px 0">

    <!-- SENSOR VALUES -->
    <div class="row">
      <div class="col"><label>Sensor 1</label><input type="number" id="s1" value="10"></div>
      <div class="col"><label>Sensor 2</label><input type="number" id="s2" value="20"></div>
    </div>
    <div class="row">
      <div class="col"><label>Sensor 3</label><input type="number" id="s3" value="30"></div>
      <div class="col"><label>Sensor 4</label><input type="number" id="s4" value="40"></div>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="btnSend" class="btn btn-primary" disabled>Kirim Sekali</button>
      <button id="btnAuto" class="btn btn-line" disabled>Auto 1/detik: OFF</button>
      <button id="btnRefresh" class="btn btn-line">Refresh OPEN Session</button>
    </div>

    <p class="muted" style="margin:10px 2px 0">Catatan: Simulator hanya kirim bila ada <b>1 sesi OPEN</b> (sesuai aturan). Payload masuk ke IoT dengan flag <code>sim:true</code>.</p>

    <h3 style="margin:14px 4px 8px">Log</h3>
    <div id="log" class="log"></div>
  </div>
</div>

<script>
function logln(msg, cls){const box=document.getElementById('log');const d=document.createElement('div');d.textContent='['+new Date().toLocaleTimeString()+'] '+msg; if(cls) d.className=cls; box.prepend(d); while(box.children.length>150) box.removeChild(box.lastChild);}
function setStatus(txt, cls){const s=document.getElementById('status'); s.textContent=txt; s.className=cls||'';}

async function api(path, method='GET', body=null){
  const url=document.getElementById('apiUrl').value.trim();
  const key=document.getElementById('apiKey').value.trim();
  const opt={method,headers:{'content-type':'application/json','x-api-key':key}};
  if(body) opt.body=JSON.stringify(body);
  const r=await fetch(url+path,opt);
  if(!r.ok){throw new Error(`${method} ${path} -> ${r.status} ${await r.text()}`)}
  return r.json();
}

async function findOpenSessionForDevice(){
  const dev=document.getElementById('deviceId').value.trim();
  const hist=await api('/history','GET');
  const open=(hist.patients||[]).find(p=>p.status==='OPEN' && p.device_id===dev);
  return open ? open.id : null;
}

async function refreshOpen(){
  try{
    setStatus('Mencari sesi OPEN…','warn');
    const sid=await findOpenSessionForDevice();
    document.getElementById('sessionId').value = sid || '';
    const enabled = !!sid;
    document.getElementById('btnSend').disabled = !enabled;
    document.getElementById('btnAuto').disabled = !enabled;
    setStatus(enabled?'READY (OPEN: '+sid+')':'Tidak ada sesi OPEN','ok');
    logln(enabled?'OPEN session: '+sid:'Tidak ada sesi OPEN untuk device ini', enabled?'ok':'warn');
  }catch(e){
    setStatus('API error','err'); logln(e.message,'err');
  }
}

function readValues(){
  const v = [Number(s1.value),Number(s2.value),Number(s3.value),Number(s4.value)];
  if(v.some(x=>!isFinite(x))) throw new Error('Nilai sensor tidak valid');
  return v;
}

async function sendOnce(){
  const sid=document.getElementById('sessionId').value.trim();
  if(!sid){ logln('No OPEN session','warn'); return; }
  const vals = readValues();
  const ts = new Date().toISOString();
  try{
    const res = await api(`/session/${encodeURIComponent(sid)}/sensor`, 'POST', { values: vals, timestamp: ts });
    logln('Publish OK ts='+ts+' values='+JSON.stringify(vals),'ok');
  }catch(e){
    logln('Gagal publish: '+e.message,'err');
  }
}

let autoTimer=null;
async function toggleAuto(){
  const btn=document.getElementById('btnAuto');
  if(autoTimer){ clearInterval(autoTimer); autoTimer=null; btn.textContent='Auto 1/detik: OFF'; return; }
  btn.textContent='Auto 1/detik: ON';
  autoTimer=setInterval(sendOnce, 1000);
}

document.getElementById('btnSend').addEventListener('click', sendOnce);
document.getElementById('btnAuto').addEventListener('click', toggleAuto);
document.getElementById('btnRefresh').addEventListener('click', refreshOpen);

(async ()=>{ await refreshOpen(); })();
</script>
</body>
</html>
