<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Simulator - SUNSTONE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #00ff00;
        }

        .header h1 {
            color: #00ff00;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            color: #888;
            font-size: 12px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .panel {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #333;
        }

        .panel-title {
            color: #00ff00;
            font-size: 16px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .oled-screen {
            background: #000;
            border: 3px solid #555;
            border-radius: 5px;
            padding: 15px;
            height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #0ff;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .oled-line {
            margin: 2px 0;
        }

        .oled-title {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        .sensor-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .sensor-control {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #444;
        }

        .sensor-label {
            color: #888;
            font-size: 11px;
            margin-bottom: 5px;
        }

        .sensor-value {
            color: #00ff00;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        input[type="range"] {
            width: 100%;
            height: 5px;
            background: #444;
            outline: none;
            border-radius: 5px;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 15px;
            height: 15px;
            background: #00ff00;
            cursor: pointer;
            border-radius: 50%;
        }

        .button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }

        .button:hover {
            background: #00cc00;
            transform: translateY(-2px);
        }

        .button:active {
            transform: translateY(0);
        }

        .button.danger {
            background: #ff0000;
            color: #fff;
        }

        .button.danger:hover {
            background: #cc0000;
        }

        .button:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #1a1a1a;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #333;
        }

        .status-led.active {
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .log-panel {
            background: #000;
            padding: 15px;
            border-radius: 5px;
            height: 400px;
            overflow-y: auto;
            font-size: 12px;
            border: 1px solid #444;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-time {
            color: #666;
        }

        .log-error {
            color: #ff0000;
        }

        .log-success {
            color: #00ff00;
        }

        .log-info {
            color: #0ff;
        }

        .config-section {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .config-item {
            margin-bottom: 10px;
        }

        .config-label {
            color: #888;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .config-value {
            color: #00ff00;
            font-size: 14px;
            background: #000;
            padding: 8px;
            border-radius: 3px;
            border: 1px solid #444;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ESP32 SIMULATOR - SUNSTONE</h1>
            <p>Virtual IoT Device for Testing | Device ID: ESP01</p>
        </div>

        <div class="main-grid">
            <!-- Left Panel: Device Control -->
            <div>
                <div class="panel">
                    <div class="panel-title">OLED DISPLAY (128x64)</div>
                    
                    <div class="oled-screen" id="oledScreen">
                        <div class="oled-title">SUNSTONE</div>
                        <div class="oled-line" style="text-align:center;">Booting...</div>
                    </div>

                    <div class="status-bar">
                        <div class="status-item">
                            <div class="status-led" id="wifiLed"></div>
                            <span>WiFi</span>
                        </div>
                        <div class="status-item">
                            <div class="status-led" id="mqttLed"></div>
                            <span>MQTT</span>
                        </div>
                        <div class="status-item">
                            <div class="status-led" id="sessionLed"></div>
                            <span>Session</span>
                        </div>
                    </div>

                    <button class="button" id="startBtn" onclick="startTest()">
                        START TEST (Rocker Switch)
                    </button>

                    <button class="button danger" id="stopBtn" onclick="stopTest()" disabled>
                        STOP TEST
                    </button>
                </div>

                <div class="panel">
                    <div class="panel-title">SENSOR CONTROLS</div>
                    
                    <div class="sensor-grid">
                        <div class="sensor-control">
                            <div class="sensor-label">MG811 - CO2</div>
                            <div class="sensor-value" id="valueMG811">300</div>
                            <input type="range" id="sliderMG811" min="200" max="600" value="300" oninput="updateSensor('MG811', this.value)">
                        </div>

                        <div class="sensor-control">
                            <div class="sensor-label">MQ7 - CO</div>
                            <div class="sensor-value" id="valueMQ7">80</div>
                            <input type="range" id="sliderMQ7" min="50" max="150" value="80" oninput="updateSensor('MQ7', this.value)">
                        </div>

                        <div class="sensor-control">
                            <div class="sensor-label">MQ3 - Alcohol</div>
                            <div class="sensor-value" id="valueMQ3">60</div>
                            <input type="range" id="sliderMQ3" min="30" max="120" value="60" oninput="updateSensor('MQ3', this.value)">
                        </div>

                        <div class="sensor-control">
                            <div class="sensor-label">MQ135 - Air Quality</div>
                            <div class="sensor-value" id="valueMQ135">220</div>
                            <input type="range" id="sliderMQ135" min="150" max="350" value="220" oninput="updateSensor('MQ135', this.value)">
                        </div>
                    </div>

                    <button class="button" onclick="randomizeSensors()">
                        RANDOMIZE SENSORS
                    </button>
                </div>
            </div>

            <!-- Right Panel: Logs & Config -->
            <div>
                <div class="panel">
                    <div class="panel-title">CONFIGURATION</div>
                    
                    <div class="config-section">
                        <div class="config-item">
                            <div class="config-label">AWS IoT Endpoint</div>
                            <div class="config-value">a2vg3urkg4mky6-ats.iot.ap-southeast-1.amazonaws.com</div>
                        </div>

                        <div class="config-item">
                            <div class="config-label">API Gateway</div>
                            <div class="config-value" id="apiEndpoint">https://dd23gtb2nc.execute-api.ap-southeast-1.amazonaws.com</div>
                        </div>

                        <div class="config-item">
                            <div class="config-label">Thing Name</div>
                            <div class="config-value">ESP01</div>
                        </div>

                        <div class="config-item">
                            <div class="config-label">Publish Interval</div>
                            <div class="config-value">2000ms (2 seconds)</div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">SERIAL MONITOR</div>
                    
                    <div class="log-panel" id="logPanel">
                        <div class="log-entry log-info">
                            <span class="log-time">[00:00:00]</span> SUNSTONE ESP32 Simulator Started
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            apiEndpoint: 'https://dd23gtb2nc.execute-api.ap-southeast-1.amazonaws.com',
            deviceId: 'ESP01',
            publishInterval: 2000
        };

        // State
        let testRunning = false;
        let publishInterval = null;
        let sensorValues = {
            mg811: 300,
            mq7: 80,
            mq3: 60,
            mq135: 220
        };

        // Initialize
        window.onload = function() {
            log('System initialized', 'info');
            log('Connecting to WiFi...', 'info');
            
            setTimeout(() => {
                document.getElementById('wifiLed').classList.add('active');
                log('WiFi connected', 'success');
                updateOLED('READY', 'Press START');
            }, 1000);

            // Simulate MQTT connection
            setTimeout(() => {
                document.getElementById('mqttLed').classList.add('active');
                log('MQTT connected to AWS IoT', 'success');
            }, 2000);
        };

        // Update sensor display
        function updateSensor(sensor, value) {
            const key = sensor.toLowerCase();
            sensorValues[key] = parseInt(value);
            document.getElementById('value' + sensor).textContent = value;
        }

        // Randomize sensors
        function randomizeSensors() {
            const ranges = {
                mg811: [200, 600],
                mq7: [50, 150],
                mq3: [30, 120],
                mq135: [150, 350]
            };

            for (const [sensor, range] of Object.entries(ranges)) {
                const value = Math.floor(Math.random() * (range[1] - range[0]) + range[0]);
                sensorValues[sensor] = value;
                
                const sensorUpper = sensor.toUpperCase().replace('MQ', 'MQ');
                document.getElementById('slider' + sensorUpper.replace('MG', 'MG')).value = value;
                document.getElementById('value' + sensorUpper.replace('MG', 'MG')).textContent = value;
            }
            
            log('Sensors randomized', 'info');
        }

        // Start test
        function startTest() {
            if (testRunning) return;
            
            testRunning = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('sessionLed').classList.add('active');
            
            log('>>> TEST STARTED <<<', 'success');
            updateOLED('TESTING', 'Sending data...');
            
            // Start publishing
            publishData();
            publishInterval = setInterval(publishData, CONFIG.publishInterval);
        }

        // Stop test
        function stopTest() {
            if (!testRunning) return;
            
            testRunning = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('sessionLed').classList.remove('active');
            
            clearInterval(publishInterval);
            
            log('>>> TEST STOPPED <<<', 'info');
            updateOLED('READY', 'Press START');
        }

        // Publish sensor data
        async function publishData() {
            const payload = {
                device_id: CONFIG.deviceId,
                timestamp: new Date().toISOString(),
                sensors: {
                    raw_mg811: sensorValues.mg811,
                    raw_mq7: sensorValues.mq7,
                    raw_mq3: sensorValues.mq3,
                    raw_mq135: sensorValues.mq135
                }
            };

            log('Publishing: ' + JSON.stringify(payload.sensors), 'info');

            // Simulate sending via Lambda (bypass IoT Core for simulator)
            try {
                const response = await fetch(`${CONFIG.apiEndpoint}/simulator/ingest`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    log('Data sent successfully', 'success');
                    updateOLEDTest();
                } else {
                    log('Failed to send data: ' + response.status, 'error');
                }
            } catch (error) {
                log('Network error: ' + error.message, 'error');
            }
        }

        // Update OLED display
        function updateOLED(title, message) {
            const screen = document.getElementById('oledScreen');
            screen.innerHTML = `
                <div class="oled-title">${title}</div>
                <div class="oled-line" style="text-align:center; margin-top:10px;">${message}</div>
            `;
        }

        function updateOLEDTest() {
            const screen = document.getElementById('oledScreen');
            screen.innerHTML = `
                <div class="oled-title">TESTING</div>
                <div style="font-size:12px;">
                    <div class="oled-line">CO2: ${sensorValues.mg811}</div>
                    <div class="oled-line">CO:  ${sensorValues.mq7}</div>
                    <div class="oled-line">ALC: ${sensorValues.mq3}</div>
                    <div class="oled-line">AIR: ${sensorValues.mq135}</div>
                </div>
            `;
        }

        // Logging
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const panel = document.getElementById('logPanel');
            
            const entry = document.createElement('div');
            entry.className = 'log-entry log-' + type;
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            
            panel.appendChild(entry);
            panel.scrollTop = panel.scrollHeight;
        }

        // Simulate receiving result from backend
        function simulateResult(category, confidence) {
            const screen = document.getElementById('oledScreen');
            screen.innerHTML = `
                <div class="oled-title">RESULT</div>
                <div style="text-align:center; font-size:18px; margin:15px 0;">
                    ${category}
                </div>
                <div style="text-align:center; font-size:12px;">
                    Conf: ${confidence}%
                </div>
            `;
            
            log(`Result received: ${category} (${confidence}%)`, 'success');
            stopTest();
        }

        // Expose for external testing
        window.simulateResult = simulateResult;
    </script>
</body>
</html>
